GadTools Integration - Progress Sync
======================================

Phase 1: Compiler Flag + Startup Code
Status: DONE
Date: 2026-01-24
Summary: Added gadtoolsused flag in parsevar.c, startup/cleanup code
  generation in parse.c (XREF entries, open with V36 error check, close
  at exit, ABORT_PROG condition), and _opengadtools/_closegadtools
  assembly routines in startup.s with _gadtoolslib string and
  _GadToolsBase BSS storage.
Files changed:
  - src/ace/c/parsevar.c (flag definition)
  - src/ace/c/parse.c (extern, XREF, startup open, abort, cleanup close)
  - src/lib/startup/startup.s (open/close routines, data, BSS)
  - verify/tests/cases/gadgets/gt_startup.b (test file, needs Phase 2)

Next: Phase 2

Phase 2: Parser Recognizes _KIND (No Tags)
Status: DONE
Date: 2026-01-24
Summary: Added 12 _KIND reserved words (BUTTON_KIND through TEXT_KIND) to
  the lexer (acedef.h enum + lexvar.c rword[] table, alphabetically sorted
  for binary search). Added gt_kind_value() helper and GadTools codegen
  path in gadget.c: when a _KIND token is detected after the rectangle,
  pushes the kind constant and NULL tagarray, calls _CreateGTGadget with
  36-byte stack cleanup, sets gadtoolsused=TRUE. Verified: gt_button.b
  generates correct xrefs (_CreateGTGadget, _opengadtools, _closegadtools),
  startup open with V36 check, move.l #1 (BUTTON_KIND), jsr _CreateGTGadget.
Files changed:
  - src/ace/c/acedef.h (12 new enum entries: buttonkindsym..textkindsym)
  - src/ace/c/lexvar.c (12 new rword[] strings)
  - src/ace/c/gadget.c (extern gadtoolsused, gt_kind_value(), GadTools path)
  - verify/tests/cases/gadgets/gt_button.b (Phase 2 test)
  - verify/tests/cases/errors/gt_bad_kind.b (negative test)
Note: gt_bad_kind.b does not produce a compile error; BOGUS_KIND falls
  through to the old-style _CreateGadget path. Explicit error detection
  for invalid _KIND tokens deferred to Phase 9 (mixing error).

Next: Phase 3

Phase 3: Tag Parsing
Status: DONE
Date: 2026-01-24
Summary: Added hardcoded tag name lookup table (40 GadTools tags, GT_TagBase
  + offset constants) and gt_tag_lookup() function in gadget.c. Extended the
  GadTools codegen path to parse comma-separated TAG=value pairs after the
  kind token: looks up tag identifier in table, parses = and integer literal
  value, builds a dc.l TagItem array in the DATA section terminated with
  TAG_DONE (0,0), and pushes the array address with pea. Added gttagcount
  counter in parsevar.c for unique label generation. Unknown tag names
  produce error 25.
Files changed:
  - src/ace/c/gadget.c (gt_tag_lookup table+function, tag parsing loop,
    DATA generation, pea for tag array address)
  - src/ace/c/parsevar.c (gttagcount counter)
  - verify/tests/cases/gadgets/gt_slider_tags.b (Phase 3 test)
  - verify/tests/cases/errors/gt_bad_tag.b (negative test - unknown tag)
Verified: gt_slider_tags.b generates _gttags0: dc.l $80080026,0,$80080027,100,0,0
  (GTSL_Min=0, GTSL_Max=100, TAG_DONE). gt_bad_tag.b (BOGUS_Tag) produces
  compile error.

Phase 4: Runtime - Gadget Creation
Status: DONE
Date: 2026-01-24
Summary: Created src/lib/c/gtgadget.c with three functions:
  - InitGadTools() [static]: Gets VisualInfo from Scrn, creates gadget list
    context via CreateContext.
  - CreateGTGadget(): Fills NewGadget struct from parameters, calls
    CreateGadgetA, stores gadget pointer, and if window is open does
    AddGList + RefreshGList + GT_RefreshWindow. Handles dynamic addition
    by RemoveGList before creating, then re-adding entire list.
  - CleanupGadTools(): Removes gadgets from window (if still open), calls
    FreeGadgets and FreeVisualInfo, resets all state.
  Uses vbcc inline stubs via proto/gadtools.h for GadTools library calls.
  Modified startup.s _closegadtools to call _CleanupGadTools before
  CloseLibrary so cleanup is automatic at program exit.
  Parameter order matches compiler stack layout (36 bytes / 9 longwords):
    tagarray, kind, y2, x2, y1, x1, label, status, id
Files changed:
  - src/lib/c/gtgadget.c (NEW - runtime module)
  - src/make/Makefile-lib (added gtgadget.c to C_SOURCES, 31 modules)
  - src/lib/startup/startup.s (xref + jsr _CleanupGadTools in _closegadtools)
  - verify/tests/cases/gadgets/gt_create_run.b (emulator test)
  - verify/tests/expected/gt_create_run.expected (expected log output)
Verification:
  - Library rebuild: PASS (make -f Makefile-lib clean all, no errors)
  - gtgadget.c warnings: only implicit declarations for RemoveGList,
    AddGList, RefreshGList (same as all other modules)
  - Runtime test (gt_create_run.b): PASS
    Log output: "PASS: gadget created" + "DONE"
Fix applied: Added xdef directives for _opengadtools, _closegadtools,
  _GadToolsBase in startup.s (missed in Phase 1). Also fixed test file
  OPEN syntax to ACE format: OPEN "O",#1,"file" (not ANSI BASIC style).

Phase 5: Event Handling
Status: DONE
Date: 2026-01-24
Summary: Added GadTools event handling to both compiler and runtime.
  Compiler: wait_gadget() generates _WaitGTGadget when gadtoolsused is set
  (gadget.c). GADGET(n) generates _GadFuncGT when gadtoolsused (basfun.c).
  ON GADGET event trapping generates _gt_gadget_event_test when gadtoolsused
  (event.c). Runtime (gtgadget.c): Added WaitGTGadget() blocking wait using
  GT_GetIMsg/GT_ReplyIMsg with automatic REFRESHWINDOW handling via
  GT_BeginRefresh/GT_EndRefresh. Added GadFuncGT(n) returning gadget info
  (n=0: event test, n=1: ID, n=2: string value, n=3: slider level from
  IDCMP Code field, n=4: gadget pointer). Added gt_gadget_event_test()
  non-blocking event check. CreateGTGadget now calls ModifyIDCMP to add
  REFRESHWINDOW to window IDCMP flags. All three functions use gt_gadnum
  and gt_lastcode module-static state.
Files changed:
  - src/ace/c/gadget.c (wait_gadget: conditional _WaitGTGadget)
  - src/ace/c/basfun.c (extern gadtoolsused, conditional _GadFuncGT)
  - src/ace/c/event.c (extern gadtoolsused, conditional _gt_gadget_event_test)
  - src/lib/c/gtgadget.c (WaitGTGadget, GadFuncGT, gt_gadget_event_test,
    gt_gadnum, gt_lastcode, CLOSEGAD, ModifyIDCMP in CreateGTGadget,
    extern set_wdw_close_num)
  - verify/tests/cases/gadgets/gt_events.b (Phase 5 emulator test)
  - verify/tests/expected/gt_events.expected (expected log output)
Verification:
  - Compiler rebuild: PASS (make -f Makefile-ace clean all, 29 modules)
  - Library rebuild: PASS (make -f Makefile-lib clean all, 31+23 modules)
  - gt_events.b compilation: PASS (no errors)
  - Generated .s contains: xref _WaitGTGadget, xref _GadFuncGT,
    jsr _WaitGTGadget, jsr _GadFuncGT, jsr _opengadtools, jsr _closegadtools
  - Runtime test (emulator click): pending manual verification

Phase 6: SETATTR / GETATTR
Status: DONE
Date: 2026-01-24
Summary: Added GADGET SETATTR and GADGET GETATTR syntax. Parser: added
  setattrsym and getattrsym reserved words to lexer (acedef.h enum,
  lexvar.c rword[]). Added setattr_gadget() in gadget.c dispatched from
  gadget() for GADGET SETATTR id, TAG=value - builds TagItem array in
  DATA section, calls _SetGTGadgetAttrs with 8-byte cleanup. Added
  gadget_getattr() static helper in basfun.c intercepted before lparen
  check in numericfunction() for GADGET GETATTR(id, TAG) - pushes tag
  constant and id, calls _GetGTGadgetAttr, returns longtype. Runtime:
  added SetGTGadgetAttrs(tagarray, id) calling GT_SetGadgetAttrsA and
  GetGTGadgetAttr(tag, id) using 2-element TagItem array with
  GT_GetGadgetAttrsA in gtgadget.c.
Files changed:
  - src/ace/c/acedef.h (getattrsym, setattrsym enum entries)
  - src/ace/c/lexvar.c ("GETATTR", "SETATTR" in rword[])
  - src/ace/c/gadget.c (setattr_gadget(), dispatch from gadget())
  - src/ace/c/basfun.c (extern gt_tag_lookup, gadget_getattr(), intercept)
  - src/lib/c/gtgadget.c (SetGTGadgetAttrs, GetGTGadgetAttr)
  - verify/tests/cases/gadgets/gt_setattr.b (Phase 6 test)
Verification:
  - Compiler rebuild: PASS (29 modules, no errors)
  - Library rebuild: PASS (31+23 modules, expected warnings only)
  - gt_setattr.b compilation: PASS (no errors)
  - Generated .s contains: xref _SetGTGadgetAttrs, xref _GetGTGadgetAttr,
    jsr _SetGTGadgetAttrs, jsr _GetGTGadgetAttr, pea _gttags0, pea _gttags1,
    _gttags0: dc.l $80080026,0,$80080027,100,$80080028,50,0,0
    _gttags1: dc.l $80080028,75,0,0
  - Tag constants verified: GTSL_Min=$80080026, GTSL_Max=$80080027,
    GTSL_Level=$80080028

Phase 7: GADGET CLOSE
Status: DONE
Date: 2026-01-24
Summary: Added CloseGTGadget(id) to gtgadget.c runtime module. The function
  removes all gadgets from the window (RemoveGList), marks the specified
  gadget slot as NULL in gt_gadgets[], then re-adds the remaining gadgets
  to the window (AddGList + RefreshGList + GT_RefreshWindow). The compiler
  side was already handled in Phase 5 (close_gadget() dispatches to
  _CloseGTGadget when gadtoolsused is set, with 4-byte stack cleanup).
Files changed:
  - src/lib/c/gtgadget.c (CloseGTGadget function)
  - verify/tests/cases/gadgets/gt_close.b (Phase 7 emulator test)
  - verify/tests/expected/gt_close.expected (expected log output)
Verification:
  - Library rebuild: PASS (incremental, only gtgadget.c recompiled)
  - Compilation: PASS (no errors)
  - Runtime test: PASS (log output matches expected: "PASS: created 2",
    "PASS: closed 1", "DONE")

Next: Phase 8

Phase 8: String Array Tags (Cycle, MX, Listview)
Status: DONE
Date: 2026-01-24
Summary: Added is_array_tag() helper to identify GTCY_Labels and GTMX_Labels
  as tags requiring STRPTR* arrays. Extended tag parsing in GadTools codegen
  path to detect string array values (ident$() syntax): looks up array in
  symbol table, records patch info, emits 0 placeholder in DATA section.
  After DATA entry, generates code to push array base address (from frame),
  num_elements, and element_size, calls _BuildGTLabels, and patches the tag
  value with move.l d0,_gttags<N>+<offset>. Runtime: added BuildGTLabels()
  to gtgadget.c that AllocMem's a (num+1)*4 byte pointer array, fills each
  entry with array_addr + i*element_size, NULL-terminates, and tracks the
  allocation for cleanup. CleanupGadTools now FreeMem's all label arrays.
  Note: GTLV_Labels (Listview) requires struct List*, not STRPTR* -- not
  covered by this phase (would need a different conversion).
Files changed:
  - src/ace/c/gadget.c (extern lev/curr_item, gt_addreg[], is_array_tag(),
    array tag detection in tag loop, patch code generation)
  - src/lib/c/gtgadget.c (MAX_LABEL_ARRAYS, gt_label_arrays[] tracking,
    BuildGTLabels() function, FreeMem cleanup in CleanupGadTools)
  - verify/tests/cases/gadgets/gt_cycle.b (Phase 8 compile test)
  - verify/tests/cases/gadgets/gt_cycle_run.b (Phase 8 emulator test)
  - verify/tests/expected/gt_cycle_run.expected (expected log output)
Verification:
  - Compiler rebuild: PASS (no errors)
  - Library rebuild: PASS (no errors)
  - gt_cycle.b compilation: PASS (no errors)
  - Generated .s contains: xref _BuildGTLabels, jsr _BuildGTLabels,
    move.l d0,_gttags0+4, pea _gttags0, jsr _CreateGTGadget
  - Tag constant: $8008000e = GT_TAGBASE+14 (GTCY_Labels)
  - Array: _array0 ds.b 3072 (3 elements * 1024)
  - BuildGTLabels params: array_addr from frame, #3 elements, #1024 size
  - Runtime test (emulator): pending (gt_cycle_run.b)
Note: ACE BASIC line continuation (_) does not work for GADGET statements.
  All tag parameters must be on a single source line.

Phase 9: Mixing Error
Status: DONE
Date: 2026-01-24
Summary: Added oldgadgetused flag in parsevar.c. Added error 81 ("Cannot
  mix old-style and GadTools gadgets") to lex.c error table. In gadget.c,
  the GadTools path checks if oldgadgetused is set (errors if so), and the
  old-style path sets oldgadgetused=TRUE and checks if gadtoolsused is set
  (errors if so). First style used wins; second style triggers the error.
Files changed:
  - src/ace/c/parsevar.c (oldgadgetused flag definition)
  - src/ace/c/lex.c (error 81 message)
  - src/ace/c/gadget.c (extern oldgadgetused, mixing checks in both paths)
  - verify/tests/cases/errors/gt_mix_error.b (Phase 9 test)
Verification:
  - Compiler rebuild: PASS (29 modules, no errors)
  - gt_mix_error.b: PASS (error 81 on line 5: "Cannot mix old-style and
    GadTools gadgets")
  - gt_button.b: PASS (pure GadTools program compiles without error)

Phase 10: Test Suite Review
Status: DONE
Date: 2026-01-24
Summary: Audited all gadgets/ tests. Fixed existing emulator tests: added END
  statements, rewrote gt_events.b to use non-blocking GADGET(0) instead of
  blocking GADGET WAIT 0. Added per-gadget-type runtime tests covering 10 of
  12 kinds (LISTVIEW_KIND skipped: requires struct List* not supported by array
  tag syntax). Each runtime test creates a gadget, uses SETATTR/GETATTR where
  supported to verify round-trip values, closes the gadget, and writes PASS/DONE
  to RAM:<testname>.log. Updated runner.rexx to check for log files
  (RAM:<testname>.log) after running a test, using them for output comparison
  when present (since GUI programs PRINT to the window, not stdout). Removed
  gt_bad_kind.b (didn't actually produce compile error). Updated expected/ files.
Files changed:
  - verify/tests/runner.rexx (log file detection after test execution)
  - verify/tests/cases/gadgets/gt_create_run.b (add END, fix comments)
  - verify/tests/cases/gadgets/gt_close.b (add END, fix comments)
  - verify/tests/cases/gadgets/gt_events.b (rewrite: non-blocking event check)
  - verify/tests/cases/gadgets/gt_cycle_run.b (add GETATTR test, add END)
  - verify/tests/cases/gadgets/gt_slider_tags.b (add comments, add END)
  - verify/tests/cases/gadgets/gt_setattr.b (add comments, add END)
  - verify/tests/cases/gadgets/gt_cycle.b (add END)
  - verify/tests/cases/gadgets/gt_slider_run.b (NEW - SLIDER SETATTR/GETATTR)
  - verify/tests/cases/gadgets/gt_checkbox_run.b (NEW - CHECKBOX GETATTR)
  - verify/tests/cases/gadgets/gt_integer_run.b (NEW - INTEGER SETATTR/GETATTR)
  - verify/tests/cases/gadgets/gt_scroller_run.b (NEW - SCROLLER SETATTR/GETATTR)
  - verify/tests/cases/gadgets/gt_palette_run.b (NEW - PALETTE GETATTR)
  - verify/tests/cases/gadgets/gt_mx_run.b (NEW - MX with labels, GETATTR)
  - verify/tests/cases/gadgets/gt_string_run.b (NEW - STRING create/close)
  - verify/tests/cases/gadgets/gt_text_run.b (NEW - TEXT create/close)
  - verify/tests/cases/gadgets/gt_number_run.b (NEW - NUMBER SETATTR)
  - verify/tests/expected/gt_*.expected (updated/new expected log outputs)
  - verify/tests/cases/errors/gt_bad_kind.b (REMOVED - didn't produce error)
Test inventory (18 tests):
  Compile-only (5): gt_startup, gt_button, gt_slider_tags, gt_setattr, gt_cycle
  Runtime/emulator (13): gt_create_run, gt_events, gt_close, gt_cycle_run,
    gt_slider_run, gt_checkbox_run, gt_integer_run, gt_scroller_run,
    gt_palette_run, gt_mx_run, gt_string_run, gt_text_run, gt_number_run
  Error (2): gt_bad_tag, gt_mix_error
Gadget kinds covered: BUTTON, SLIDER, CHECKBOX, INTEGER, SCROLLER,
  PALETTE, MX, CYCLE, STRING, TEXT, NUMBER (11 of 12; LISTVIEW deferred)
Verification:
  - Runner (gadgets): 18 passed, 0 failed, 0 skipped
    - Compile-only (5): gt_startup, gt_button, gt_slider_tags, gt_setattr, gt_cycle
    - Runtime verified (13): all produced correct log files matching expected/
  - Runner (errors): 6 passed, 0 failed (gt_bad_tag, gt_mix_error both error correctly)
  - All runtime tests open windows, create gadgets, write logs, exit cleanly

Next: Phase 11

Phase 11: Documentation
Status: DONE
Date: 2026-01-24
Summary: Added GadTools documentation to both reference files. In ref.txt:
  added GADGET (GadTools) entry with full syntax, kind table (12 types),
  tag table (40 tags with kind and description), string array usage, examples,
  and cross-references. Added GADGET SETATTR and GADGET GETATTR entries with
  syntax and examples. In ace.txt: added "GadTools Gadgets" subsection to the
  Gadgets section with overview, requirements, supported kinds, complete
  working example (slider + button with event handling and GETATTR), SETATTR
  usage, Cycle/MX string array example, and mixing restriction note.
Files changed:
  - docs/ref.txt (GADGET GadTools, GADGET SETATTR, GADGET GETATTR entries)
  - docs/ace.txt (GadTools Gadgets subsection)

All 11 phases complete. GadTools integration is finished.
