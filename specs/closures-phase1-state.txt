Phase 1 (INVOKE) — Implementation State
========================================
Date: 2026-01-27
Status: COMPLETE — all tests pass (85 existing + 3 closures, 0 failures)

Files Modified
--------------
1. src/ace/c/acedef.h
   - Added `invokesym` to ACE reserved word enum (between integerkindsym and listviewkindsym)

2. src/ace/c/lexvar.c
   - Added "INVOKE" to rword[] array (between "INTEGER_KIND" and "LISTVIEW_KIND")

3. src/ace/c/parsevar.c
   - Added global `SYM *last_addr_sub_sym = NULL;`
   - Set by @SubName evaluation, consumed by assign() to link function pointer
     variables to their target SUB's SYM node via the `other` field

4. src/ace/c/basfun.c
   - In address_of_object(): when @ is used on a subprogram, sets
     `last_addr_sub_sym = curr_item` to capture the SUB's SYM

5. src/ace/c/assign.c
   - In assign(), case variable: after storing a longtype value, checks
     `last_addr_sub_sym` and links `storage_item->other` to the SUB's SYM.
     Clears last_addr_sub_sym after use.

6. src/ace/c/statement.c
   - Added INVOKE statement handler between IFF and KILL in the dispatcher.
   - Two code paths:
     a) SUB convention (when variable->other is set to a subprogram):
        Uses load_params() for argument passing, then indirect jsr through variable.
     b) MC/C convention (when variable->other is not set):
        Uses load_mc_params() for argument passing (C-style push on stack),
        indirect jsr, then pops parameters.

7. src/ace/c/factor.c
   - Added `case invokesym:` in factor() switch for expression context.
   - Same two code paths as statement, plus pushes return value:
     a) SUB convention: reads return value from SUB's frame variable (level ZERO)
        or d0 (for external SUBs), respects sub type (short/long/single).
     b) MC/C convention: pushes d0 as longtype return value.

Files Created
-------------
1. verify/tests/cases/closures/funcptr_basic.b — zero-parameter SUB call via pointer
2. verify/tests/cases/closures/funcptr_params.b — INVOKE with params and return value
3. verify/tests/cases/closures/funcptr_pass.b — @SubName address consistency test
4. verify/tests/expected/funcptr_basic.expected
5. verify/tests/expected/funcptr_params.expected
6. verify/tests/expected/funcptr_pass.expected

Design Decisions
----------------
- INVOKE uses two calling conventions based on compile-time information:
  1. When the variable was directly assigned via `funcPtr& = @SubName`, the
     compiler links the variable to the SUB's SYM via the `other` field.
     At INVOKE time, load_params() is used (same as a direct CALL to the SUB).
     This preserves the SUB's frame-based parameter passing convention.
  2. When no SUB linkage exists, INVOKE uses load_mc_params() (C/stack convention).
     This works for MC subroutines and external functions.

- The `other` field linkage only applies to direct assignments like `funcPtr& = @Add`.
  If the pointer is passed through a variable or SUB parameter, the linkage is lost
  and the MC convention is used as fallback.

- Return value handling:
  - SUB convention: reads from SUB's frame variable (same as direct call)
  - MC convention: reads d0, returns longtype

Known Limitations (Phase 1)
----------------------------
- Function pointer passed as a parameter to another SUB loses the `other` linkage.
  INVOKE inside that SUB would use MC convention, which won't work for regular SUBs.
  Workaround: only INVOKE where the direct @SubName assignment was made.
- No runtime type checking of argument count/types for MC convention calls.
- No DECLARE INVOKE or explicit function pointer type — uses LONGINT variables.

What Phase 2 (BIND/Closures) Should Build On
---------------------------------------------
- The INVOKE keyword and expression/statement handlers are in place.
- The `other` field linkage mechanism can be extended for BIND.
- BIND will need a runtime closure struct (function pointer + captured args).
- INVOKE will need a third code path: detect closure struct, unpack captured args,
  then call the underlying function.
- Consider adding `closuresym` and `bindsym` keywords using the same pattern:
  acedef.h enum + lexvar.c rword[] insertion in alphabetical order.

Cleanup Needed
--------------
- Restore verify/scripts/otherthenamiga/aos3/S/user-startup to remove test commands.
